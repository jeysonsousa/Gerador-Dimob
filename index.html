<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIMOB Web Cloud</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; margin: auto; background-color: #f0f2f5; color: #333; max-width: 1000px; }
        h1 { color: #1a73e8; margin-bottom: 5px; text-align: center; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        
        .container { background: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #1a73e8; }
        .card-locacao { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; position: relative; }
        .card-header { font-size: 18px; font-weight: bold; color: #1a73e8; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .btn-remover { position: absolute; top: 15px; right: 20px; background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        
        label { font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #555; }
        input[type="text"], input[type="number"], input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        .table-container { overflow-x: auto; margin-top: 15px; background: white; padding: 10px; border: 1px solid #eee; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        th { background-color: #e3f2fd; color: #1a73e8; }
        input.financeiro { width: 80px; text-align: right; border: 1px solid #ccc; padding: 4px; border-radius: 3px; }

        .btn-replicar { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-bottom: 10px; font-weight: bold;}
        .btn-add { background: #1a73e8; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold; width: 100%; margin-bottom: 20px;}
        .btn-gerar { background: #2e7d32; color: white; border: none; padding: 15px 20px; border-radius: 5px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-gerar:hover { background: #1b5e20; }
        
        #mensagem { margin-top: 20px; padding: 15px; border-radius: 5px; display: none; font-size: 14px; font-weight: bold; text-align: center; }
        .erro { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .sucesso { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

    <h1>DIMOB Web Cloud</h1>
    <p class="subtitle">Preencha os dados diretamente na tela e gere o arquivo validador oficial.</p>

    <div class="container">
        <div class="card-header">1. Dados da Empresa (Administradora / Imobiliária)</div>
        <div class="form-grid">
            <div class="form-group">
                <label>Ano Base (Ex: 2024):</label>
                <input type="number" id="empAno" value="2024">
            </div>
            <div class="form-group">
                <label>CNPJ (Somente números):</label>
                <input type="text" id="empCnpj" maxlength="14" placeholder="14 dígitos">
            </div>
            <div class="form-group full-width">
                <label>Razão Social:</label>
                <input type="text" id="empRazao" maxlength="60" placeholder="Ex: DMD EMPREENDIMENTOS">
            </div>
            <div class="form-group">
                <label>CPF do Responsável:</label>
                <input type="text" id="empCpfResp" maxlength="11" placeholder="11 dígitos">
            </div>
            <div class="form-group full-width">
                <label>Endereço Completo:</label>
                <input type="text" id="empEndereco" maxlength="120" placeholder="Rua, Número, Bairro">
            </div>
        </div>
    </div>

    <div id="areaLocacoes"></div>

    <button class="btn-add" onclick="adicionarLocacao()">+ Adicionar Novo Contrato de Locação</button>

    <button class="btn-gerar" onclick="gerarDimob()">Gerar Arquivo DIMOB para o PGD</button>

    <div id="mensagem"></div>

    <script>
        let contadorLocacao = 0;
        const mesesLabel = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];

        const formatarDataDimob = (dataHtml) => {
            if(!dataHtml) return "".padEnd(8, " ");
            const partes = dataHtml.split('-');
            if(partes.length !== 3) return "".padEnd(8, " ");
            return `${partes[2]}${partes[1]}${partes[0]}`; 
        };

        const limparDocumento = (doc) => doc ? doc.toString().replace(/\D/g, '') : '';
        
        const formatarTexto = (texto, tamanho) => {
            if (!texto) return ''.padEnd(tamanho, ' ');
            let formatado = texto.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            formatado = formatado.replace(/[^A-Z0-9 ]/g, ''); 
            return formatado.substring(0, tamanho).padEnd(tamanho, ' ');
        };

        const formatarMoedaDimob = (valorForm) => {
            if (!valorForm || valorForm === "") return ''.padStart(14, '0');
            let numero = parseFloat(valorForm.replace(',', '.'));
            if (isNaN(numero)) numero = 0;
            const emCentavos = Math.round(numero * 100).toString();
            return emCentavos.padStart(14, '0');
        };

        function adicionarLocacao() {
            contadorLocacao++;
            const id = contadorLocacao;
            const div = document.createElement('div');
            div.className = 'card-locacao';
            div.id = `locacao-${id}`;
            
            let tabelaMeses = `<tr><th>Mês</th><th>Rendimento Bruto (R$)</th><th>Comissão Retida (R$)</th><th>IRRF Retido (R$)</th></tr>`;
            mesesLabel.forEach((mes, idx) => {
                tabelaMeses += `
                <tr>
                    <td><strong>${mes}</strong></td>
                    <td><input type="text" class="financeiro aluguel-${id}" id="aluguel-${id}-${idx}" placeholder="0,00"></td>
                    <td><input type="text" class="financeiro comissao-${id}" id="comissao-${id}-${idx}" placeholder="0,00"></td>
                    <td><input type="text" class="financeiro irrf-${id}" id="irrf-${id}-${idx}" placeholder="0,00"></td>
                </tr>`;
            });

            div.innerHTML = `
                <div class="card-header">Contrato de Locação #${id}</div>
                <button class="btn-remover" onclick="removerLocacao(${id})">X Remover</button>
                
                <div class="form-grid">
                    <div class="form-group"><label>CPF/CNPJ Locador (Dono):</label><input type="text" id="locadorDoc-${id}" maxlength="14"></div>
                    <div class="form-group full-width"><label>Nome do Locador:</label><input type="text" id="locadorNome-${id}" maxlength="60"></div>
                    
                    <div class="form-group"><label>CPF/CNPJ Locatário (Inquilino):</label><input type="text" id="locatarioDoc-${id}" maxlength="14"></div>
                    <div class="form-group full-width"><label>Nome do Locatário:</label><input type="text" id="locatarioNome-${id}" maxlength="60"></div>
                    
                    <div class="form-group"><label>Número do Contrato:</label><input type="text" id="numContrato-${id}" maxlength="6"></div>
                    <div class="form-group"><label>Data do Contrato:</label><input type="date" id="dataContrato-${id}"></div>
                    
                    <div class="form-group full-width"><label>Endereço do Imóvel:</label><input type="text" id="imovelEnd-${id}" maxlength="60"></div>
                    <div class="form-group"><label>CEP do Imóvel:</label><input type="text" id="imovelCep-${id}" maxlength="8"></div>
                </div>

                <div class="table-container">
                    <button class="btn-replicar" onclick="replicarValores(${id})">⬇️ Copiar valores de JANEIRO para todos os meses</button>
                    <table>${tabelaMeses}</table>
                </div>
            `;
            document.getElementById('areaLocacoes').appendChild(div);
        }

        function removerLocacao(id) {
            const el = document.getElementById(`locacao-${id}`);
            if(el) el.remove();
        }

        function replicarValores(id) {
            const aluguelJan = document.getElementById(`aluguel-${id}-0`).value;
            const comissaoJan = document.getElementById(`comissao-${id}-0`).value;
            const irrfJan = document.getElementById(`irrf-${id}-0`).value;

            for (let i = 1; i < 12; i++) {
                document.getElementById(`aluguel-${id}-${i}`).value = aluguelJan;
                document.getElementById(`comissao-${id}-${i}`).value = comissaoJan;
                document.getElementById(`irrf-${id}-${i}`).value = irrfJan;
            }
        }

        function exibirMensagem(texto, tipo) {
            const msgBox = document.getElementById('mensagem');
            msgBox.innerHTML = texto;
            msgBox.className = tipo;
            msgBox.style.display = 'block';
            setTimeout(() => { msgBox.style.display = 'none'; }, 8000);
        }

        function gerarDimob() {
            const anoBase = document.getElementById('empAno').value;
            const cnpjDeclarante = limparDocumento(document.getElementById('empCnpj').value).padEnd(14, ' ');
            const razaoSocial = formatarTexto(document.getElementById('empRazao').value, 60);
            const cpfResponsavel = limparDocumento(document.getElementById('empCpfResp').value).padStart(11, '0');
            const enderecoDeclarante = formatarTexto(document.getElementById('empEndereco').value, 120);

            if (!anoBase || cnpjDeclarante.trim().length !== 14 || cpfResponsavel.replace(/0/g,'').length === 0) {
                exibirMensagem("Preencha corretamente os dados da Administradora (CNPJ e CPF são obrigatórios).", "erro");
                return;
            }

            const cards = document.querySelectorAll('.card-locacao');
            if (cards.length === 0) {
                exibirMensagem("Adicione pelo menos um contrato de locação.", "erro");
                return;
            }

            let conteudoTxt = "";

            // 1. HEADER (T00) - Blindado em exatos 356 caracteres
            const anoEntrega = (parseInt(anoBase) + 1).toString();
            const restoHeader = "PA030061772010002991330287000000000000000000066300701207698";
            let linhaHeader = `DIMOB       ${anoEntrega}17250${cnpjDeclarante}2280${razaoSocial}${restoHeader}`;
            linhaHeader = linhaHeader.padEnd(356, ' ').substring(0, 356);
            conteudoTxt += linhaHeader + "\r\n";

            // 2. DECLARANTE (R01) - Blindado em exatos 260 caracteres (Correção dos 10 espaços extras)
            const zerosFiller = "0".repeat(22);
            const codigoMunicipioPadrao = "0427"; 
            const ufPadrao = "PA";
            // A matemática exata: a string R01 até o município dá 240. Mais 20 espaços = 260 cravados.
            let r01 = `R01${cnpjDeclarante}${anoBase}${zerosFiller}${razaoSocial}${cpfResponsavel}${enderecoDeclarante}${ufPadrao}${codigoMunicipioPadrao}${" ".repeat(20)}`;
            r01 = r01.padEnd(260, ' ').substring(0, 260);
            conteudoTxt += r01 + "\r\n";

            // 3. LOCAÇÕES (R02) - Blindado em exatos 798 caracteres
            let indexArray = 1;
            cards.forEach(card => {
                const idStr = card.id.split('-')[1];
                
                const sequencial = (indexArray).toString().padEnd(5, ' ');
                
                const cpfCnpjLocador = limparDocumento(document.getElementById(`locadorDoc-${idStr}`).value).padEnd(14, ' ');
                const nomeLocador = formatarTexto(document.getElementById(`locadorNome-${idStr}`).value, 60);
                const cpfCnpjLocatario = limparDocumento(document.getElementById(`locatarioDoc-${idStr}`).value).padEnd(14, ' ');
                const nomeLocatario = formatarTexto(document.getElementById(`locatarioNome-${idStr}`).value, 60);
                const numContrato = formatarTexto(document.getElementById(`numContrato-${idStr}`).value, 6);
                
                const dataRaw = document.getElementById(`dataContrato-${idStr}`).value;
                const dataContrato = formatarDataDimob(dataRaw);
                
                let valoresFinanceiros = "";
                for (let i = 0; i < 12; i++) {
                    valoresFinanceiros += formatarMoedaDimob(document.getElementById(`aluguel-${idStr}-${i}`).value);
                    valoresFinanceiros += formatarMoedaDimob(document.getElementById(`comissao-${idStr}-${i}`).value);
                    valoresFinanceiros += formatarMoedaDimob(document.getElementById(`irrf-${idStr}-${i}`).value);
                }

                const endereco = formatarTexto(document.getElementById(`imovelEnd-${idStr}`).value, 60);
                const cep = formatarTexto(limparDocumento(document.getElementById(`imovelCep-${idStr}`).value), 8);
                const codMunicipio = formatarTexto(codigoMunicipioPadrao, 4); 
                const munVazio = " ".repeat(20);
                const uf = formatarTexto(ufPadrao, 2);
                const fillerR02 = " ".repeat(10);

                let r02 = `R02${cnpjDeclarante}${anoBase}${sequencial}${cpfCnpjLocador}${nomeLocador}${cpfCnpjLocatario}${nomeLocatario}${numContrato}${dataContrato}${valoresFinanceiros}0U${endereco}${cep}${codMunicipio}${munVazio}${uf}${fillerR02}`;
                r02 = r02.padEnd(798, ' ').substring(0, 798);
                
                conteudoTxt += r02 + "\r\n"; 
                indexArray++;
            });

            // 4. TRAILER (T9) - Blindado em exatos 105 caracteres
            const totalLinhas = (cards.length + 3).toString().padStart(8, '0');
            let t9 = `T9${cnpjDeclarante}${anoBase}${totalLinhas}`;
            t9 = t9.padEnd(105, ' ').substring(0, 105);
            conteudoTxt += t9 + "\r\n";

            // GERAR ARQUIVO COM MATRIZ DE BYTES (ASCII PURA)
            const byteArray = new Uint8Array(conteudoTxt.length);
            for (let i = 0; i < conteudoTxt.length; i++) {
                byteArray[i] = conteudoTxt.charCodeAt(i) & 0xFF;
            }

            const blob = new Blob([byteArray], { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `DIMOB_WEB_VALIDADO_${anoBase}.txt`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            exibirMensagem("Arquivo DIMOB gerado com sucesso! As posições foram matematicamente travadas.", "sucesso");
        }

        window.onload = adicionarLocacao;
    </script>
</body>
</html>

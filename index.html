<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador DIMOB Multiempresas</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 40px; 
            max-width: 800px; 
            margin: auto; 
            background-color: #f0f2f5;
        }
        h1 { color: #1a73e8; margin-bottom: 5px; }
        p { color: #555; margin-bottom: 25px; line-height: 1.5; }
        
        .container { 
            border: 1px solid #ccc; 
            padding: 30px; 
            border-radius: 8px; 
            background: #ffffff; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 2; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #333; }
        input[type="text"], input[type="number"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.2);
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #abb8c3;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }
        input[type="file"] { margin: 10px auto; display: block; }
        
        #mensagem { 
            margin-top: 20px; 
            padding: 15px;
            border-radius: 5px;
            display: none;
            font-size: 14px;
            line-height: 1.5;
        }
        .erro { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .sucesso { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Gerador DIMOB</h1>
        <p>Preencha os dados da empresa declarante e faça o upload da planilha Excel com os dados dos locatários para gerar o arquivo de importação (.txt).</p>
        
        <div class="form-grid">
            <div class="form-group">
                <label for="inputAno">Ano Calendário (Ref. aos dados):</label>
                <input type="number" id="inputAno" value="2025" min="2000" max="2099">
            </div>
            <div class="form-group">
                <label for="inputCnpj">CNPJ da Empresa Declarante:</label>
                <input type="text" id="inputCnpj" placeholder="Apenas números" maxlength="14">
            </div>
            <div class="form-group full-width">
                <label for="inputRazaoSocial">Razão Social da Empresa Declarante:</label>
                <input type="text" id="inputRazaoSocial" placeholder="Ex: WWM HOLDING EMPREENDIMENTOS..." maxlength="60">
            </div>
        </div>

        <div class="upload-section">
            <label style="font-size: 16px; color: #1a73e8;">Selecione a Planilha de Locatários</label>
            <input type="file" id="uploadPlanilha" accept=".xlsx, .xls, .csv">
        </div>

        <div id="mensagem"></div>
    </div>

    <script>
        // --- FUNÇÕES DE FORMATAÇÃO POSICIONAL ---
        const limparDocumento = (doc) => {
            if (!doc) return '';
            return doc.toString().replace(/\D/g, '');
        };

        const formatarTexto = (texto, tamanho) => {
            if (!texto) return ''.padEnd(tamanho, ' ');
            let formatado = texto.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            formatado = formatado.replace(/[^A-Z0-9 ]/g, ''); 
            return formatado.substring(0, tamanho).padEnd(tamanho, ' ');
        };

        const formatarMoeda = (valor, tamanho) => {
            if (!valor) return ''.padStart(tamanho, '0');
            let numero = typeof valor === 'string' ? parseFloat(valor.replace(',', '.')) : parseFloat(valor);
            if (isNaN(numero)) numero = 0;
            const emCentavos = Math.round(numero * 100).toString();
            return emCentavos.padStart(tamanho, '0');
        };

        const exibirMensagem = (html, tipo) => {
            const div = document.getElementById('mensagem');
            div.style.display = 'block';
            div.className = tipo;
            div.innerHTML = html;
        };

        // --- GATILHO DE LEITURA DO ARQUIVO ---
        document.getElementById('uploadPlanilha').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('mensagem').style.display = 'none';

            const ano = document.getElementById('inputAno').value;
            const cnpjRaw = document.getElementById('inputCnpj').value;
            const razaoSocialRaw = document.getElementById('inputRazaoSocial').value;

            if(!ano || limparDocumento(cnpjRaw).length !== 14 || !razaoSocialRaw) {
                exibirMensagem('<strong>Atenção:</strong> Preencha corretamente o Ano, CNPJ (14 dígitos) e Razão Social antes de selecionar a planilha.', 'erro');
                this.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.SheetNames[0];
                    const linhas = XLSX.utils.sheet_to_json(workbook.Sheets[primeiraAba], { defval: "" });
                    
                    gerarArquivoTxt(linhas, ano, cnpjRaw, razaoSocialRaw);
                } catch (error) {
                    exibirMensagem('Erro ao ler a planilha. Verifique se o formato é um Excel válido.', 'erro');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // --- LÓGICA PRINCIPAL DE MONTAGEM ---
        function gerarArquivoTxt(linhas, anoForm, cnpjForm, razaoSocialForm) {
            const errosValidacao = [];

            linhas.forEach((linha, index) => {
                const numLinhaExcel = index + 2; 
                const docLocador = limparDocumento(linha['CPF_CNPJ_LOCADOR']);
                const docLocatario = limparDocumento(linha['CPF_CNPJ_LOCATARIO']);

                if (docLocador.length !== 11 && docLocador.length !== 14) {
                    errosValidacao.push(`Linha ${numLinhaExcel}: Documento do Locador inválido (${docLocador.length} dígitos).`);
                }
                if (docLocatario.length !== 11 && docLocatario.length !== 14) {
                    errosValidacao.push(`Linha ${numLinhaExcel}: Documento do Locatário inválido (${docLocatario.length} dígitos).`);
                }
            });

            if (errosValidacao.length > 0) {
                const listaErros = errosValidacao.join('<br>• ');
                exibirMensagem(`<strong>Não foi possível gerar o arquivo. Corrija a planilha:</strong><br><br>• ${listaErros}`, 'erro');
                document.getElementById('uploadPlanilha').value = '';
                return; 
            }

            const anoBase = anoForm;
            const anoEntrega = (parseInt(anoBase) + 1).toString();
            // CNPJ e Razão Social (Padrões fixos do layout)
            const cnpjDeclarante = limparDocumento(cnpjForm).padEnd(14, ' ');
            const razaoSocial = formatarTexto(razaoSocialForm, 60);
            
            let conteudoTxt = "";

            // --- REGISTRO HEADER (T00) - 366 posições ---
            const restoHeader = "PA030061772010002991330287000000000000000000066300701207698";
            const linhaHeader = `DIMOB       ${anoEntrega}17250${cnpjDeclarante}2280${razaoSocial}${restoHeader}`.padEnd(366, ' ');
            conteudoTxt += linhaHeader + '\r\n';

            // --- REGISTRO R01 (Declarante) - 260 posições ---
            const restoR01 = "02991330287AVENIDA ALMIRANTE BARROSO, NO 700, SALA 201, EDIFICIO ASPEB OFFICE                                                      PA0427BELEM            ";
            const linhaR01 = `R01${cnpjDeclarante}${anoBase}0000000000000000000000${razaoSocial}${restoR01}`.padEnd(260, ' ');
            conteudoTxt += linhaR01 + '\r\n';

            // --- REGISTROS R02 (Locações) - 783 posições ---
            linhas.forEach((linha, index) => {
                const sequencial = (index + 1).toString().padStart(7, '0'); // AGORA COM 7 DÍGITOS
                
                // Documentos alinhados à esquerda e preenchidos com espaço (Correção essencial para CPFs)
                const cpfCnpjLocador = limparDocumento(linha['CPF_CNPJ_LOCADOR']).padEnd(14, ' ');
                const nomeLocador = formatarTexto(linha['NOME_LOCADOR'], 60);
                const cpfCnpjLocatario = limparDocumento(linha['CPF_CNPJ_LOCATARIO']).padEnd(14, ' ');
                const nomeLocatario = formatarTexto(linha['NOME_LOCATARIO'], 60);
                const dataContrato = formatarTexto(linha['DATA_CONTRATO'], 8);
                
                const meses = ['JAN', 'FEV', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'];
                let valoresFinanceiros = "";

                meses.forEach(mes => {
                    const aluguel = formatarMoeda(linha[`ALUGUEL_${mes}`], 14);
                    const comissao = formatarMoeda(linha[`COMISSAO_${mes}`], 14);
                    const irrf = formatarMoeda(linha[`IRRF_${mes}`], 14);
                    valoresFinanceiros += `${aluguel}${comissao}${irrf}`;
                });

                // Inserindo o "U" de Imóvel Urbano e os 20 espaços do nome do Município
                const tipoImovel = "U";
                const endereco = formatarTexto(linha['ENDERECO_IMOVEL'], 60);
                const cep = formatarTexto(limparDocumento(linha['CEP']), 8);
                const codMunicipio = formatarTexto(linha['COD_MUNICIPIO'] || '0427', 4);
                const nomeMunicipio = formatarTexto(linha['MUNICIPIO'] || 'BELEM', 20);
                const uf = formatarTexto(linha['UF'] || 'PA', 2);

                const linhaR02 = `R02${cnpjDeclarante}${anoBase}${sequencial}${cpfCnpjLocador}${nomeLocador}${cpfCnpjLocatario}${nomeLocatario}${dataContrato}${valoresFinanceiros}${tipoImovel}${endereco}${cep}${codMunicipio}${nomeMunicipio}${uf}`.padEnd(783, ' ');
                
                conteudoTxt += linhaR02 + '\r\n'; 
            });

            // --- REGISTRO T9 (Trailer) - 105 posições ---
            const totalRegistros = (linhas.length + 2).toString().padStart(8, '0');
            const linhaT9 = `T9${cnpjDeclarante}${anoBase}${totalRegistros}`.padEnd(105, ' ');
            conteudoTxt += linhaT9 + '\r\n';

            // Disparo de Download
            const blob = new Blob([conteudoTxt], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `DIMOB_${limparDocumento(cnpjDeclarante)}_${anoBase}.txt`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            exibirMensagem('<strong>Arquivo gerado com sucesso!</strong> Importe no PGD da Receita Federal.', 'sucesso');
            document.getElementById('uploadPlanilha').value = ''; 
        }
    </script>
</body>
</html>
